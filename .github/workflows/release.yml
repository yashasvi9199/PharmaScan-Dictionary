name: Build & Release Dictionary

on:
  workflow_dispatch: {}
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * 0" # Run weekly on Sunday

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --no-warnings
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Switch to main branch
        run: git checkout main || git checkout -b main origin/main

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Download WHO ATC CSV
        run: |
          mkdir -p data
          curl -sS -L -o data/atc.csv "https://raw.githubusercontent.com/fabkury/atcd/master/WHO%20ATC-DDD%202024-07-31.csv"

      - name: Run Ingest & Build Pipeline
        run: |
          # This runs the full pipeline: ingest -> dedupe -> clean -> bundle -> version -> checksum
          # Note: version.json will be generated with default or env version here, but we will update it later.
          sh ingest/run_ingest.sh

      - name: Bump Version
        id: bump
        run: |
          # Bump patch version in package.json
          node scripts/bump_version.js > new_version.txt
          VERSION=$(cat new_version.txt)
          # VERSION is like "v0.1.1"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Update dist/version.json with the new version
          # generate_version.js expects DICT_VERSION env var (without v prefix usually, but let's check)
          # scripts/generate_version.js: const version = process.env.DICT_VERSION || "0.1.0";
          # We'll pass the clean version number.
          CLEAN_VERSION=${VERSION#v}
          export DICT_VERSION=$CLEAN_VERSION
          node scripts/generate_version.js

          echo "Bumped to $VERSION"

      - name: Commit & Push Changes
        run: |
          git config user.name "yashasvi9199"
          git config user.email "yashasvi9199@gmail.com"

          # git checkout/pull removed to avoid conflicts with dirty tree
          # We are already on main from the earlier step

          # Add package.json (version bump) and dist/ (artifacts)
          git add package.json dist/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: release ${{ steps.bump.outputs.version }} [skip ci]"
            git tag -a "${{ steps.bump.outputs.version }}" -m "Release ${{ steps.bump.outputs.version }}"
            git push origin main --tags
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.bump.outputs.version }}
          name: ${{ steps.bump.outputs.version }}
          body: |
            Automated release of PharmaScan Dictionary.
          files: |
            dist/dictionary.bundle.json
            dist/dictionary.bundle.json.sha256
            dist/version.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy
        uses: actions/deploy-pages@v4
