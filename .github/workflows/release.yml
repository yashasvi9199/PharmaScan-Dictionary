name: Build & Release Dictionary

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  issues: write
  pages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --no-warnings
    steps:

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Ensure scripts executable
      run: |
        chmod +x ingest/run_ingest.sh || true
        chmod +x scripts/*.js || true

    - name: Download WHO ATC CSV
      run: |
        mkdir -p data
        curl -sS -L -o data/atc.csv "https://raw.githubusercontent.com/fabkury/atcd/master/WHO%20ATC-DDD%202024-07-31.csv"

    - name: Run full pipeline (ingest → dedupe → clean → bundle → version → checksum)
      run: |
        sh ingest/run_ingest.sh

    - name: Read version
      id: ver
      run: |
        if [ -f dist/version.json ]; then
          VERSION=$(jq -r .version dist/version.json)
        else
          VERSION="0.0.0-$(date -u +%Y%m%d%H%M%S)"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

    - name: Create Git tag (annotated)
      run: |
        TAG="v${{ steps.ver.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git tag -a "$TAG" -m "Release $TAG" || true
        git push origin "$TAG" || true

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: "v${{ steps.ver.outputs.version }}"
        release_name: "v${{ steps.ver.outputs.version }}"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload bundle asset to Release
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/dictionary.bundle.json
        asset_name: dictionary.bundle.json
        asset_content_type: application/json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload sha256 to Release
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/dictionary.bundle.json.sha256
        asset_name: dictionary.bundle.json.sha256
        asset_content_type: text/plain
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact for GitHub Pages
      uses: actions/upload-pages-artifact@v1
      with:
        path: dist

    - name: Deploy to GitHub Pages (publish latest bundle)
      uses: actions/deploy-pages@v1
      # no inputs needed; this will deploy contents uploaded above to the repo's Pages site

    - name: (optional) Publish to S3-compatible CDN
      if: ${{ secrets.CDN_S3_BUCKET && secrets.CDN_S3_ENDPOINT }}
      run: |
        python3 - <<'PY'
import os,subprocess
bucket=os.environ['CDN_S3_BUCKET']
endpoint=os.environ['CDN_S3_ENDPOINT']
access=os.environ['CDN_S3_ACCESS_KEY']
secret=os.environ['CDN_S3_SECRET_KEY']
subprocess.check_call(['pip','install','--quiet','awscli'])
cmd = ['aws','s3','--endpoint-url', endpoint, 'cp', 'dist/dictionary.bundle.json', f's3://{bucket}/dictionary.bundle.json']
env = os.environ.copy()
env['AWS_ACCESS_KEY_ID']=access
env['AWS_SECRET_ACCESS_KEY']=secret
subprocess.check_call(cmd, env=env)
print("uploaded to CDN")
PY

    - name: Upload build artifact (CI artifact)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dictionary-dist
        path: |
          dist/dictionary.bundle.json
          dist/dictionary.bundle.json.sha256
          dist/version.json

    - name: Post Checkout cleanup
      run: echo "CI completed"